<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>AiMinder</title>
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html {
      height: 100%;
      margin: 0;
      background: #f0f2f5;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      overflow: hidden;
    }
    #container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    #chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      background: #fff;
      padding: 16px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
      background: #fafafa;
      border-radius: 8px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    .chat-message {
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 20px;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .chat-user { background: #d0e6ff; }
    .chat-ai { background: #ececec; }
    #input-area {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    #message-input {
      flex: 1;
      font-size: 16px;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }
    #send-btn {
      background-color: #3a8ee6;
      border: none;
      color: white;
      padding: 0 20px;
      border-radius: 20px;
      cursor: pointer;
    }
    #right-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      padding: 16px;
    }
    #large-box {
      flex: 1;
      background: #2e4b3a;         
      border-radius: 8px;
      border: 1px solid #1c2d23;   
      padding: 16px;
      overflow-y: auto;
      font-family: 'Indie Flower', cursive;
      white-space: pre-wrap;
      font-size: 20px;              
      color: #e0e0e0;              
      font-weight: bold;            
    }
    #btn-group {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    #btn-group button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
    }
    #upload-summarize {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
 /* loaderç‚¹åŠ¨ç”»ä¿æŒ */
    .loader-dots {
      display: inline-flex;
      align-items: center;
      font-size: 18px;
    }
    .loader-dot {
      margin: 0 2px;
      opacity: 0.3;
      animation: blink 1s infinite;
    }
    .loader-dot:nth-child(1) { animation-delay: 0s; }
    .loader-dot:nth-child(2) { animation-delay: 0.2s; }
    .loader-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #fff;
  border-top: 2px solid #3a8ee6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}

@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
#upload-summarize {
  display: flex;
  justify-content: center; /* æ°´å¹³å±…ä¸­ */
  gap: 12px;               /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
  margin-top: 12px;
}

/* é€šç”¨æŒ‰é’®æ ·å¼ */
#btn-group button,
#upload-summarize button {
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 16px;
  border: none;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  transition: background-color 0.3s;
}

/* æ©™è‰²ï¼šä¸Šä¸€ä¸ªæ¿ä¹¦ */
#prev-btn {
  background-color: #f0ad4e;
  color: white;
}
#prev-btn:hover {
  background-color: #ec971f;
}

/* è“è‰²ï¼šä¸‹ä¸€ä¸ªæ¿ä¹¦ */
#next-btn {
  background-color: #5bc0de;
  color: white;
}
#next-btn:hover {
  background-color: #31b0d5;
}

/* ç»¿è‰²ï¼šä¸€é”®æ¿ä¹¦ */
#summarize-btn {
  background-color: #5cb85c;
  color: white;
}
#summarize-btn:hover {
  background-color: #449d44;
}


  </style>
</head>
<body>
  <div id="container">
    <section id="chat-section">
      <div id="chat"></div>
      <div id="input-area">
        <input type="text" id="message-input" placeholder="è¾“å…¥æ‚¨éœ€è¦å­¦ä¹ çš„å†…å®¹..." autocomplete="off" />
        <button id="send-btn">å‘é€</button>
      </div>
    </section>
    <section id="right-section">
      <div id="large-box">æš‚æ— å†…å®¹</div>
      <div id="btn-group">
       <button id="prev-btn">ä¸Šä¸€ä¸ªæ¿ä¹¦</button>
  <button id="next-btn">ä¸‹ä¸€ä¸ªæ¿ä¹¦</button>
      </div>
   
<div id="upload-summarize">
  <button id="custom-upload-btn">ä¸Šä¼ æ•™æ</button>
  <input type="file" id="file-input" style="display:none;" />
  <button id="summarize-btn">
    <span class="spinner" style="display:none;"></span>
    ä¸€é”®æ¿ä¹¦
  </button>
</div>


    </section>
  </div>

<script>
const sendBtn = document.getElementById('send-btn');
const input = document.getElementById('message-input');
const chat = document.getElementById('chat');
const largeBox = document.getElementById('large-box');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const summarizeBtn = document.getElementById('summarize-btn');
const fileInput = document.getElementById('file-input');

let history = [];
let currentIndex = -1;

// ---- å·¦è¾¹èŠå¤©å†å²åŠ è½½----
window.addEventListener('load', () => {
  fetch('/get_historyaiminder')
    .then(response => response.json())
    .then(data => {
      if (data && data.length > 0) {
        let lastUserInput = "";
        for (let i = 0; i < data.length; i++) {
          const item = data[i];
          if (item.role === 'user') {
            lastUserInput = item.content;
            const userDiv = document.createElement('div');
            userDiv.className = "chat-message chat-user";
            userDiv.innerHTML = `<strong>æˆ‘ï¼š</strong>${item.content}`;
            chat.appendChild(userDiv);
          } else if (item.role === 'assistant') {
            const content = JSON.parse(item.content);
            const aiDiv = document.createElement('div');
            aiDiv.className = "chat-message chat-ai";
            const formatted = content.text.replace(/\n/g, "<br>");
            aiDiv.innerHTML = `<strong>AiMinderï¼š</strong>${formatted}`;
            chat.appendChild(aiDiv);
            history.push({input: lastUserInput, reply: content.text});
          }
        }
        currentIndex = history.length - 1;
        setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 100);
      }
    });

  loadSummaries();
});

sendBtn.addEventListener('click', () => {
  const message = input.value.trim();
  if (!message) return;
  
  input.value = '';

  // ç”¨æˆ·æ¶ˆæ¯
  const userDiv = document.createElement('div');
  userDiv.className = "chat-message chat-user";
  userDiv.innerHTML = `<strong>æˆ‘ï¼š</strong>${message}`;
  chat.appendChild(userDiv);
  chat.scrollTop = chat.scrollHeight;

  // AIæ­£åœ¨æ€è€ƒ
  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = "chat-message chat-ai";
  thinkingDiv.innerHTML = `
    <strong>AiMinderï¼š</strong>
    <span class="loader-dots">
      <span class="loader-dot">â—</span>
      <span class="loader-dot">â—</span>
      <span class="loader-dot">â—</span>
    </span>
    <br>
    <span class="waiting-time">æ­£åœ¨æ€è€ƒä¸­ï¼Œé¢„è®¡ç­‰å¾…30sï¼Œå·²ç»æ€è€ƒ0s</span>
    <br>
     <span class="tips-text"></span>
  `;
  chat.appendChild(thinkingDiv);
  chat.scrollTop = chat.scrollHeight;

  const waitingTimeSpan = thinkingDiv.querySelector('.waiting-time');


 const tipsSpan = thinkingDiv.querySelector('.tips-text');
  const tips = [
   "è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººçš„è¿åŠ¨å­¦ä¸åŠ¨åŠ›å­¦å»ºæ¨¡æ˜¯ç»“æ„è®¾è®¡çš„åŸºç¡€ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººçš„å…³èŠ‚ç±»å‹ä¸»è¦åŒ…æ‹¬æ—‹è½¬å…³èŠ‚å’Œç§»åŠ¨å…³èŠ‚ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æ¨¡å—åŒ–æœºå™¨äººè®¾è®¡èƒ½æé«˜çµæ´»æ€§ä¸é€‚åº”æ€§ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººæœ«ç«¯æ‰§è¡Œå™¨çš„é€‰æ‹©è¦æ ¹æ®ä»»åŠ¡ç‰¹æ€§å†³å®šã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å·®é€Ÿé©±åŠ¨å¸¸ç”¨äºä¸¤è½®ç§»åŠ¨æœºå™¨äººã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å¤šè‡ªç”±åº¦æœºæ¢°è‡‚éœ€è¦æ±‚è§£é€†è¿åŠ¨å­¦ä»¥ç¡®å®šå…³èŠ‚è§’åº¦ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å¸¸è§çš„æœºå™¨äººææ–™åŒ…æ‹¬é“åˆé‡‘ã€ç¢³çº¤ç»´å’Œå·¥ç¨‹å¡‘æ–™ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– ä¼ºæœç”µæœºä¸æ­¥è¿›ç”µæœºæ˜¯æœºå™¨äººå…³èŠ‚å¸¸ç”¨çš„é©±åŠ¨æ–¹å¼ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– è¿åŠ¨è§„åˆ’ç®—æ³•å¦‚A*å’ŒRRTç”¨äºè·¯å¾„ç”Ÿæˆã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººæ§åˆ¶åˆ†ä¸ºå¼€ç¯æ§åˆ¶å’Œé—­ç¯æ§åˆ¶ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– SLAMæŠ€æœ¯è®©ç§»åŠ¨æœºå™¨äººå®ç°è‡ªä¸»å®šä½ä¸åœ°å›¾æ„å»ºã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æŸ”æ€§é©±åŠ¨å¯ä»¥æå‡æœºå™¨äººåœ¨å¤æ‚ç¯å¢ƒä¸‹çš„é€‚åº”èƒ½åŠ›ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººæ„ŸçŸ¥ç³»ç»ŸåŒ…æ‹¬æ¿€å…‰é›·è¾¾ã€æ‘„åƒå¤´å’Œè¶…å£°æ³¢ä¼ æ„Ÿå™¨ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å†—ä½™æœºæ¢°è‡‚å¯é€šè¿‡ä¼˜åŒ–æé«˜ä½œä¸šç¨³å®šæ€§ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æ™ºèƒ½ç®—æ³•å¯ä»¥æ ¹æ®ä»»åŠ¡åŠ¨æ€è°ƒæ•´ç»“æ„å‚æ•°ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– ä»¿ç”Ÿæœºå™¨äººé€šè¿‡æ¨¡ä»¿è‡ªç„¶ç•Œç”Ÿç‰©å®ç°å¤æ‚è¿åŠ¨ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å…­è¶³æœºå™¨äººå…·æœ‰è‰¯å¥½çš„è¶Šéšœèƒ½åŠ›å’Œç¨³å®šæ€§ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å››è¶³æœºå™¨äººåœ¨åŠ¨æ€æ­¥æ€è§„åˆ’ä¸­éœ€è€ƒè™‘è¶³ç«¯æ¥è§¦åŠ›ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨äººçš„é—­ç¯æ§åˆ¶ä¾èµ–ä¼ æ„Ÿå™¨åé¦ˆç²¾ç¡®ä¿®æ­£åŠ¨ä½œã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å¿«é€ŸåŸå‹å¼€å‘å¯ä»¥æ˜¾è‘—ç¼©çŸ­æœºå™¨äººè®¾è®¡å‘¨æœŸã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– ä»¿çœŸå¹³å°å¦‚Gazeboå’ŒWebotså¸¸ç”¨äºéªŒè¯æ§åˆ¶ç®—æ³•ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– æœºå™¨è§†è§‰ç”¨äºè¯†åˆ«ã€å®šä½å’Œè·Ÿè¸ªç›®æ ‡ç‰©ä½“ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– å¤šæœºå™¨äººåä½œç³»ç»Ÿå¯æå‡ä½œä¸šæ•ˆç‡å’Œç³»ç»Ÿé²æ£’æ€§ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– åŸºäºæ·±åº¦å­¦ä¹ çš„æ„ŸçŸ¥ç³»ç»Ÿèƒ½å®ç°æ›´å¼ºçš„ç¯å¢ƒç†è§£èƒ½åŠ›ã€‚",

"è®©æˆ‘ä»¬åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å·©å›ºçŸ¥è¯†ï¼š\n ğŸ¤– åŠ¨åŠ›å­¦å»ºæ¨¡éœ€è€ƒè™‘æ‘©æ“¦ã€æƒ¯æ€§å’Œå…³èŠ‚å¼¹æ€§ç­‰å› ç´ ã€‚",
  ];
  let tipIndex = 0;


  let seconds = 0;
  const timer = setInterval(() => {
    seconds++;
    waitingTimeSpan.textContent = `æ­£åœ¨æ€è€ƒä¸­ï¼Œé¢„è®¡ç­‰å¾…30sï¼Œå·²ç»æ€è€ƒ${seconds}s`;
    chat.scrollTop = chat.scrollHeight;
  }, 1000);


// æ¯4ç§’æ›´æ–°æç¤º
tipsSpan.innerHTML = tips[tipIndex].replace(/\n/g, "<br>");
const tipsTimer = setInterval(() => {
  tipIndex = (tipIndex + 1) % tips.length;
  tipsSpan.innerHTML = tips[tipIndex].replace(/\n/g, "<br>");
  chat.scrollTop = chat.scrollHeight;
}, 4000);


  fetch('/chataiminder', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({message: message})
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(timer);
    thinkingDiv.remove();

    const aiDiv = document.createElement('div');
    aiDiv.className = "chat-message chat-ai";
    aiDiv.innerHTML = `<strong>AiMinderï¼š</strong><span></span>`;
    const typingSpan = aiDiv.querySelector('span');
    chat.appendChild(aiDiv);
    chat.scrollTop = chat.scrollHeight;

    let i = 0;
    let buffer = "";
    function typeWriter() {
      if (i < data.reply.length) {
        const char = data.reply.charAt(i);
        buffer += (char === "\n") ? "<br>" : char;
        typingSpan.innerHTML = buffer;
        i++;
        setTimeout(typeWriter, 5);
        chat.scrollTop = chat.scrollHeight;
      }
    }
    typeWriter();

    history.push({
      input: message,
      reply: data.reply,
      image_url: data.image_url,
      code: data.code
    });
    currentIndex = history.length - 1;

    input.value = '';
  });
});

// ------- å³è¾¹æ€»ç»“ç›¸å…³å˜é‡ -------
let summaries = [];               // å­˜æ€»ç»“
let currentSummaryIndex = -1;     // å½“å‰æ€»ç»“ç´¢å¼•

function loadSummaries() {
  fetch('/get_summaries')
    .then(response => response.json())
    .then(data => {
      summaries = data;
      if (summaries.length > 0) {
        currentSummaryIndex = summaries.length - 1;
        showCurrentSummary();
      } else {
        currentSummaryIndex = -1;
        largeBox.textContent = "æš‚æ— å†…å®¹";
      }
    });
}

function showCurrentSummary() {
  if (currentSummaryIndex >= 0 && currentSummaryIndex < summaries.length) {
    largeBox.textContent = summaries[currentSummaryIndex].content;
  } else {
    largeBox.textContent = "æš‚æ— å†…å®¹";
  }
  largeBox.scrollTop = 0;
}

prevBtn.addEventListener('click', () => {
  if (summaries.length === 0) {
    largeBox.textContent = "æš‚æ— å†…å®¹";
    return;
  }
  if (currentSummaryIndex > 0) {
    currentSummaryIndex--;
    showCurrentSummary();
  } else {
    alert("å·²ç»æ˜¯æœ€æ—©çš„æ¿ä¹¦ï¼");
  }
});

nextBtn.addEventListener('click', () => {
  if (summaries.length === 0) {
    largeBox.textContent = "æš‚æ— å†…å®¹";
    return;
  }
  if (currentSummaryIndex < summaries.length - 1) {
    currentSummaryIndex++;
    showCurrentSummary();
  } else {
    alert("å·²ç»æ˜¯æœ€æ–°çš„æ¿ä¹¦ï¼");
  }
});


const spinner = summarizeBtn.querySelector('.spinner');

summarizeBtn.addEventListener('click', () => {
  spinner.style.display = 'inline-block';
  summarizeBtn.disabled = true;
  largeBox.textContent = "æ­£åœ¨æ€»ç»“å¹¶æ¿ä¹¦ï¼Œè¯·ç¨å€™...";

  fetch('/summarize')
    .then(response => response.json())
    .then(data => {
      alert(data.message || "æ¿ä¹¦å·²ç”Ÿæˆï¼");
      // é‡æ–°åŠ è½½æ€»ç»“åˆ—è¡¨ï¼Œè‡ªåŠ¨æ›´æ–° summaries æ•°ç»„å’Œç´¢å¼•
      return fetch('/get_summaries');
    })
    .then(response => response.json())
    .then(data => {
      summaries = data;  // **æ›´æ–° summaries æ•°ç»„**
      if (summaries.length > 0) {
        currentSummaryIndex = summaries.length - 1;  // **æŒ‡å‘æœ€æ–°æ€»ç»“**
        showCurrentSummary();  // æ˜¾ç¤ºæœ€æ–°æ€»ç»“
      } else {
        currentSummaryIndex = -1;
        largeBox.textContent = "æš‚æ— å†…å®¹";
      }
    })
    .catch(err => {
      largeBox.textContent = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
      console.error(err);
    })
    .finally(() => {
      spinner.style.display = 'none';
      summarizeBtn.disabled = false;
    });
});


fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (file) {
    const formData = new FormData();
    formData.append('file', file);
    fetch('/upload', { method: 'POST', body: formData })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
    });
  }
});

const customUploadBtn = document.getElementById('custom-upload-btn');
customUploadBtn.addEventListener('click', () => {
  fileInput.click();
});


input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendBtn.click();
});
</script>
</body>
</html>
