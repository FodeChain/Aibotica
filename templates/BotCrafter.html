<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>BotCrafter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* 整体背景和布局 */
    body, html {
      height: 100%;
      margin: 0;
      background: #f0f2f5;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      overflow: hidden; /* 防止双滚动条 */
    }
    #container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    /* 左侧聊天区域 */
    #chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      background: #fff;
      padding: 16px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
      background: #fafafa;
      border-radius: 8px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    /* 气泡样式 */
    .chat-message {
      width: 100%;
      max-width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 20px;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 15px;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    //.chat-user {
     // background: #d0e6ff;
    //  align-self: stretch;
    //  border-bottom-right-radius: 4px;
    //  text-align: left;
   // }
   // .chat-ai {
   //   background: #ececec;
  //    align-self: stretch;
   //   border-bottom-left-radius: 4px;
   //   text-align: left; 
   // }
   .chat-user { background: #d0e6ff; }
    .chat-ai { background: #ececec; }
    #input-area {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    
    /* 输入框区域 */
    #input-area {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    #message-input {
      flex: 1;
      font-size: 16px;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s;
    }
    #message-input:focus {
      border-color: #3a8ee6;
      box-shadow: 0 0 5px rgba(58,142,230,0.5);
    }
    #send-btn {
      background-color: #3a8ee6;
      border: none;
      color: white;
      padding: 0 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    #send-btn:hover {
      background-color: #337acc;
    }

    /* 右侧图片和代码区域 */
    #right-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      padding: 16px;
    }
    #image-container {
      position: relative;
      flex: 1;
      border-radius: 8px;
      background: #fafafa;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    #version-title {
      font-weight: 700;
      color: #555;
      margin-bottom: 12px;
      font-size: 16px;
    }
    #generated-image {
      flex: 1;
      object-fit: contain;
      border-radius: 8px;
      background: white;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      margin-bottom: 12px;
      max-height: 70vh;
      width: 100%;
    }
   #code-display {
      display: none;
      white-space: pre-wrap;
      background: #f8f9fa;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: Consolas, "Courier New", monospace;
      font-size: 14px;
      overflow-y: auto;
      max-height: 650px;
      flex: none;
    }
    

    /* 右上按钮组 */
    #btn-group {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    #btn-group button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      transition: background-color 0.3s;
    }
    #prev-btn {
      background-color: #f0ad4e;
      color: white;
    }
    #prev-btn:hover {
      background-color: #ec971f;
    }
    #next-btn {
      background-color: #5bc0de;
      color: white;
    }
    #next-btn:hover {
      background-color: #31b0d5;
    }
    #toggle-btn {
      background-color: #6c757d;
      color: white;
    }
    #toggle-btn:hover {
      background-color: #5a6268;
    }
    #open-3d-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background-color: #5cb85c;
      color: white;
      padding: 8px 14px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s;
    }
    #open-3d-btn:hover {
      background-color: #449d44;
    }

    /* loader点动画保持 */
    .loader-dots {
      display: inline-flex;
      align-items: center;
      font-size: 18px;
    }
    .loader-dot {
      margin: 0 2px;
      opacity: 0.3;
      animation: blink 1s infinite;
    }
    .loader-dot:nth-child(1) { animation-delay: 0s; }
    .loader-dot:nth-child(2) { animation-delay: 0.2s; }
    .loader-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }

  </style>
</head>
<body>
  <div id="container">
    <section id="chat-section">
      <div id="chat"></div>
      <div id="input-area">
        <input type="text" id="message-input" placeholder="输入您需要学习的内容..." autocomplete="off" />
        <button id="send-btn">发送</button>
      </div>
    </section>
    <section id="right-section">
      <div id="image-container">
        <div id="version-title">暂无学习记录</div>
        <div id="btn-group">
          <button id="prev-btn">上一个主题</button>
          <button id="next-btn">下一个主题</button>
          <button id="toggle-btn">查看代码</button>
        </div>
        <img id="generated-image" src="" alt="暂无生成图纸" />
        <div id="code-display"></div>
        <button id="open-3d-btn">在OpenSCAD中学习</button>
      </div>
    </section>
  </div>

<script>
const sendBtn = document.getElementById('send-btn');
const input = document.getElementById('message-input');
const chat = document.getElementById('chat');
const image = document.getElementById('generated-image');
const codeDisplay = document.getElementById('code-display');
const toggleBtn = document.getElementById('toggle-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const versionTitle = document.getElementById('version-title');
const open3dBtn = document.getElementById('open-3d-btn');

let history = [];
let currentIndex = -1;

// 加载历史
window.addEventListener('load', () => {
  fetch('/get_history')
  .then(response => response.json())
  .then(data => {
    if (data && data.length > 0) {
      let lastUserInput = "";
      for (let i = 0; i < data.length; i++) {
        const item = data[i];
        if (item.role === 'user') {
          lastUserInput = item.content;
          const userDiv = document.createElement('div');
          userDiv.className = "chat-message chat-user";
          userDiv.innerHTML = `<strong>我：</strong>${item.content}`;
          chat.appendChild(userDiv);
        } else if (item.role === 'assistant') {
          const content = JSON.parse(item.content);
          const aiDiv = document.createElement('div');
          aiDiv.className = "chat-message chat-ai";
          const formatted = content.text.replace(/\n/g, "<br>");
          aiDiv.innerHTML = `<strong>BotCrafter：</strong>${formatted}`;
          chat.appendChild(aiDiv);
          history.push({
            input: lastUserInput,
            reply: content.text,
            image_url: content.image_url,
            code: content.code
          });
        }
      }
      currentIndex = history.length - 1;
      showCurrent();
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 100);
    }
  });
});

sendBtn.addEventListener('click', () => {
  const message = input.value.trim();
  if (!message) return;
  
  input.value = '';

  // 用户消息
  const userDiv = document.createElement('div');
  userDiv.className = "chat-message chat-user";
  userDiv.innerHTML = `<strong>我：</strong>${message}`;
  chat.appendChild(userDiv);
  chat.scrollTop = chat.scrollHeight;

  // AI正在思考
  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = "chat-message chat-ai";
  thinkingDiv.innerHTML = `
    <strong>BotCrafter：</strong>
    <span class="loader-dots">
      <span class="loader-dot">●</span>
      <span class="loader-dot">●</span>
      <span class="loader-dot">●</span>
    </span>
    <br>
    <span class="waiting-time">正在为您设计，预计等待2分钟，已等待0s</span>
    <br>
    <span class="tips-text"></span>
  `;
  chat.appendChild(thinkingDiv);
  chat.scrollTop = chat.scrollHeight;

  const waitingTimeSpan = thinkingDiv.querySelector('.waiting-time');
  const tipsSpan = thinkingDiv.querySelector('.tips-text');

  const tips = [
   "让我们利用碎片化时间巩固知识：\n 🤖 机器人的运动学与动力学建模是结构设计的基础。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器人的关节类型主要包括旋转关节和移动关节。",

"让我们利用碎片化时间巩固知识：\n 🤖 模块化机器人设计能提高灵活性与适应性。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器人末端执行器的选择要根据任务特性决定。",

"让我们利用碎片化时间巩固知识：\n 🤖 差速驱动常用于两轮移动机器人。",

"让我们利用碎片化时间巩固知识：\n 🤖 多自由度机械臂需要求解逆运动学以确定关节角度。",

"让我们利用碎片化时间巩固知识：\n 🤖 常见的机器人材料包括铝合金、碳纤维和工程塑料。",

"让我们利用碎片化时间巩固知识：\n 🤖 伺服电机与步进电机是机器人关节常用的驱动方式。",

"让我们利用碎片化时间巩固知识：\n 🤖 运动规划算法如A*和RRT用于路径生成。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器人控制分为开环控制和闭环控制。",

"让我们利用碎片化时间巩固知识：\n 🤖 SLAM技术让移动机器人实现自主定位与地图构建。",

"让我们利用碎片化时间巩固知识：\n 🤖 柔性驱动可以提升机器人在复杂环境下的适应能力。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器人感知系统包括激光雷达、摄像头和超声波传感器。",

"让我们利用碎片化时间巩固知识：\n 🤖 冗余机械臂可通过优化提高作业稳定性。",

"让我们利用碎片化时间巩固知识：\n 🤖 智能算法可以根据任务动态调整结构参数。",

"让我们利用碎片化时间巩固知识：\n 🤖 仿生机器人通过模仿自然界生物实现复杂运动。",

"让我们利用碎片化时间巩固知识：\n 🤖 六足机器人具有良好的越障能力和稳定性。",

"让我们利用碎片化时间巩固知识：\n 🤖 四足机器人在动态步态规划中需考虑足端接触力。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器人的闭环控制依赖传感器反馈精确修正动作。",

"让我们利用碎片化时间巩固知识：\n 🤖 快速原型开发可以显著缩短机器人设计周期。",

"让我们利用碎片化时间巩固知识：\n 🤖 仿真平台如Gazebo和Webots常用于验证控制算法。",

"让我们利用碎片化时间巩固知识：\n 🤖 机器视觉用于识别、定位和跟踪目标物体。",

"让我们利用碎片化时间巩固知识：\n 🤖 多机器人协作系统可提升作业效率和系统鲁棒性。",

"让我们利用碎片化时间巩固知识：\n 🤖 基于深度学习的感知系统能实现更强的环境理解能力。",

"让我们利用碎片化时间巩固知识：\n 🤖 动力学建模需考虑摩擦、惯性和关节弹性等因素。",


  ];
  let tipIndex = 0;

  // 开始更新已等待时间
  let seconds = 0;
  const timer = setInterval(() => {
    seconds++;
    waitingTimeSpan.textContent = `正在为您设计，预计等待2分钟，已等待${seconds}s`;
    chat.scrollTop = chat.scrollHeight;
  }, 1000);

// 每4秒更新提示
tipsSpan.innerHTML = tips[tipIndex].replace(/\n/g, "<br>");
const tipsTimer = setInterval(() => {
  tipIndex = (tipIndex + 1) % tips.length;
  tipsSpan.innerHTML = tips[tipIndex].replace(/\n/g, "<br>");
  chat.scrollTop = chat.scrollHeight;
}, 4000);

  fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({message: message})
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(timer);
    clearInterval(tipsTimer);
    thinkingDiv.remove();

    // AI回复
    const aiDiv = document.createElement('div');
    aiDiv.className = "chat-message chat-ai";
    aiDiv.innerHTML = `<strong>BotCrafter：</strong><span></span>`;
    const typingSpan = aiDiv.querySelector('span');
    chat.appendChild(aiDiv);
    chat.scrollTop = chat.scrollHeight;

    // 打字效果
    let i = 0;
    let buffer = "";
    function typeWriter() {
      if (i < data.reply.length) {
        const char = data.reply.charAt(i);
        if (char === "\n") {
          buffer += "<br>";
        } else {
          buffer += char;
        }
        typingSpan.innerHTML = buffer;
        i++;
        setTimeout(typeWriter, 5);
        chat.scrollTop = chat.scrollHeight;
      }
    }
    typeWriter();

    history.push({
      input: message,
      reply: data.reply,
      image_url: data.image_url,
      code: data.code
    });
    currentIndex = history.length - 1;
    showCurrent();

    input.value = '';
  });
});

// 监听输入框按键
input.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    sendBtn.click();
  }
});

toggleBtn.addEventListener('click', () => {
  if (image.style.display !== "none") {
    image.style.display = "none";
    codeDisplay.style.display = "block";
    toggleBtn.textContent = "查看图纸";
    // 切换到代码，滚动到顶部
    codeDisplay.scrollTop = 0;
  } else {
    image.style.display = "block";
    codeDisplay.style.display = "none";
    toggleBtn.textContent = "查看代码";
  }
});


prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    showCurrent();
  } else {
    alert("已经是最早的记录！");
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < history.length - 1) {
    currentIndex++;
    showCurrent();
  } else {
    alert("已经是最新的记录！");
  }
});

function showCurrent() {
  if (currentIndex >= 0 && currentIndex < history.length) {
    const item = history[currentIndex];
    versionTitle.textContent = `学习主题: ${item.input}...`;
    image.src = item.image_url;
    codeDisplay.textContent = item.code;
    image.style.display = "block";
    codeDisplay.style.display = "none";
    toggleBtn.textContent = "查看代码";
    
    // 每次切换版本时，代码区滚动重置
    codeDisplay.scrollTop = 0;
  } else {
    versionTitle.textContent = "暂无学习记录";
  }
}


open3dBtn.addEventListener('click', () => {
  if (currentIndex >= 0 && currentIndex < history.length) {
    const item = history[currentIndex];
    fetch('/open3d', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ code: item.code })
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
    })
    .catch(err => {
      alert("请求出错：" + err);
    });
  } else {
    alert("没有可用的代码！");
  }
});
</script>

</body>
</html>
